<!DOCTYPE html>
<html lang="pt">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <link rel="shortcut icon" type="image/png" href="imagens/osl.ico">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
        integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />
    <script src="https://www.gstatic.com/firebasejs/8.6.7/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.7/firebase-database.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link rel="stylesheet" href="style.css">
    <title>Carregando produto..</title>
</head>

<body>
    <div class="whatsapp-button">
        <a href="https://wa.me/5584994239716?text=Preciso+de+ajuda" target="_blank">
            <img src="https://upload.wikimedia.org/wikipedia/commons/6/6b/WhatsApp.svg" alt="">
        </a>
    </div>

    <!-- PopUp Loading -->
    <div class="bob " id="bob">
        <div class="popup-content">
            <div class="loader"></div>
            <p>Processando pagamento...</p>
        </div>
    </div>

    <!-- Popup copiado -->
    <div class="copy " id="copy">
        <div class="popup-content">
            <i class="fa-solid fa-circle-check" style="font-size: 44px; margin-bottom: 5px;"></i>
            <p>Copiado com sucesso</p>
        </div>
    </div>

    <div id="error-prod" class="error-prod hide">
        <img style="height: 150px;" src="imagens/Logo2pay.png" alt="Imagem de Erro.">
        <h2 style="font-family: Poppins;">Ops, algo está errado..</h2>
        <p style="color: rgb(107 114 128 1);font-family: Poppins; text-align: center;">Produto não disponível, inativo
            ou bloqueado. Contate o suporte para mais informações.</p>
    </div>

    <!-- COUNTDOWN - DRIFIS -->
    <div id="corp" class="corp ">
        <div id="timer" style="justify-content: center; align-items: center;">
            <p><span id="countdown" style="font-size: 25px;">10:01</span> <i style="margin: 0px 10px 0px 10px;"
                    class="fa-regular fa-clock"></i> Oferta esgotando</p>
        </div>



        <!-- BANNER -->
        <div id="banner-div" style="display: none;">
            <img src="" alt="Banner de Oferta" id="banner">
        </div>



        <!-- Head do Produto ------------------------------------>
        <div id="head" class="head bor">
            <div id="img-head-div">
                <img id="img-head" src="imagens/img-prod-padrao.png" alt="Imagem do Produto">
            </div>
            <div id="detalhes-prod-div">
                <h4 id="detalhes-prod"></h4>
                <p id="descricao-prod">Com order bump e pixel de rastreamento meta, otimizado para conversões diretas
                </p>
                <p style="margin-right: 4px; font-size: 11px; margin-top: 7px; font-style: tachado;">de <s
                        id="preco-original" style="color: #7C7C7C; font-weight: 600;">R$ 97,00</s> por
                </p>
                <div style="display: flex; align-items: baseline;">
                    <h2 id="preco-prod"></h2>
                </div>
            </div>
        </div>



        <!-- Form para gerar o PIX ------------------------------------>
        <div id="form-container">
            <div style="display: flex; align-items: center;">
                <i class="fa-solid fa-envelope-circle-check"
                    style="color:aliceblue; margin-right: 4px; font-size: 11px;"></i>
                <p id="text-p" class="text-p">Verifique seus dados. Você receberá no seu Email</p>
            </div>
            <form id="checkout-form">
                <div class="inp-text">
                    <label for="nome_completo">Nome Completo</label>
                    <input type="text" id="nome_completo" autocomplete="name" placeholder="Digite seu nome completo"
                        required>
                </div>
                <label for="email">Email</label>
                <input type="email" id="email" placeholder="E-mail" required><br>
                <label for="tel">Celular</label>
                <input type="tel" maxlength="18" id="tel" autocomplete="tel" placeholder="+55 99 99999-9999" value="+55"
                    required><br>


                <!-- Container de Seleção de pagamentos ------------------------------------>
                <div class="pag-div" style="display: flex;">
                    <div class="pags pix">
                        <img src="https://logospng.org/download/pix/logo-pix-256.png" alt="Logo Pix Payment">
                    </div>
                    <div class="pags cartao">
                        <img src="https://cdn-icons-png.freepik.com/512/15925/15925800.png?ga=GA1.1.1321081237.1742502701"
                            alt="Logo Pix Payment">
                    </div>
                </div>
                <div id="como-pagar" style="font-family: Satoshi; display: flex; flex-direction: column;">
                    <ul id="como-pagar-ul">
                        <li>Vamos gerar um codigo pix</li>
                    </ul>
                </div>
                <!-- Botão de Compra    ------------------------------------>
                <button type="submit" id="btn">COMPRAR E RECEBER AGORA</button>




                <!-- Lista de Coisa Boa -->
                <div id="secure" style="display: flex; justify-content: center; align-items: center; margin-top: 10px;">
                    <i style="font-size: 12px; color: var(--color-verde-escuro);" class="fa-solid fa-lock"></i>
                    <p
                        style="margin-left: 5px; font-size: 12px; color: var(--color-verde-escuro); font-weight: 600; font-family: 'Inter';">
                        Compra
                        100%
                        segura</p><br>
                </div>
                <div id="secure" style="display: flex; justify-content: center; align-items: center; margin-top: 1px;">
                    <i style="font-size: 12px; color: var(--color-verde-escuro);" class="fa-solid fa-paper-plane"></i>
                    <p
                        style="margin-left: 5px; font-size: 12px; color: var(--color-verde-escuro); font-weight: 600; font-family: 'Inter';">
                        Liberação
                        imediata</p><br>
                </div>

                <!-- Logo Twopay -->
                <div id="logo-div"
                    style="display: flex; justify-content: center; align-items: center; margin-top: 10px; width: 100%; height: auto;">
                    <img style="width: 50px; height: 19px; filter: grayscale(1);" src="imagens/Logo2pay.png"></img>
                </div>


                <div style="width: 100%; display: flex; text-align: center; justify-content: center;">

                    <p
                        style="width: 90%; text-align: center;   font-family: Poppins; font-weight: 500; color: #7C7C7C;">
                        Seu pagamento está sendo processado por <b>Twopay</b> para o vendedor <span
                            id="nome_vendedor">NomeDoVendedor</span>. Ambiente 100% seguro. </p>
                </div>

            </form>
        </div>


        <!-- Container Do Pix // Geração do Pix -->
        <div id="pix-container">
            <div style="display: flex; align-items: center; justify-content: center;">
                <h2 id="status">Aguardando pagamento</h2>
                <div id="loading" class="loading">
                    <div class="dot"></div>
                    <div class="dot"></div>
                    <div class="dot"></div>
                </div>
            </div>

            <h3 id="scan">Escaneie o QR Code ou copie o código PIX</h3>
            <img id="pix-qr" src="" alt="QR Code PIX">
            <div id="pix-code-div">
                <p id="pix-code"></p>
            </div>
            <div id="como-pagar">
                <ul id="como-pagar-ul">
                    <li>Abra o app do seu banco</li>
                    <li>Entre na opcão Pix "Copia e cola"</li>
                    <li>Cole o código</li>
                    <li>Confirme o pagamento</li>
                </ul>
            </div>
            <button id="btnconf"><i style="margin-right: 10px;" class="fa-solid fa-copy"></i>Copiar Codigo Pix</button>


            <!-- Lista de Coisa Boa -->
            <div id="secure"
                style="display: flex; justify-content: center; align-items: center; margin-top: 7px; margin-bottom: 10px;">
                <i style="font-size: 14x; color:#7C7C7C;" class="fa-solid fa-lock"></i>
                <p style="margin-left: 5px; font-size: 13px; color: #7C7C7C; font-weight: 780; font-family: 'Inter';">
                    Compra segura | Dados
                    protegidos</p><br>
            </div>

            <!-- Logo Twopay -->
            <div id="logo-div"
                style="display: flex; justify-content: center; align-items: center; margin-top: 10px; width: 100%; height: auto;">
                <img style="width: 50px; height: 19px; filter: grayscale(1);" src="imagens/Logo2pay.png"></img>
            </div>

        </div>
    </div>
    <div style="width: 100%; display: flex; text-align: center; justify-content: center; flex-direction: column;">

        <p
            style="width: 100%; text-align: center; margin-top: 10px;  font-family: Poppins; font-weight: 500; color: #7C7C7C; font-size: 9px;">
            Termos de Compra, Termos de Uso, e Política de Privacidade.</p>
        <p
            style="width: 100%; text-align: center; margin-top: 10px;  font-family: Poppins; font-weight: 500; color: #7C7C7C; font-size: 9px;">
            Twopay | Todos os Direitos Reservados</p>
    </div>
    <script>
        let paymentId = null;
        let produto = null;

        const firebaseConfig = {
            apiKey: "AIzaSyB0DFXPILXxKAkjaKOHvgnppV3CY7xR9Cs",
            authDomain: "meu-checkout-web.firebaseapp.com",
            databaseURL: "https://meu-checkout-web-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "meu-checkout-web",
            storageBucket: "meu-checkout-web.firebasestorage.app",
            messagingSenderId: "422699934016",
            appId: "1:422699934016:web:7910537a1f8d5457929aa5",
            measurementId: "G-VRKRL1MR9S"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();


        // Função para pegar parâmetros da URL
        function getQueryParam(param) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(param);
        }

        const productId = getQueryParam("pv");
        const orderId = getQueryParam("order");



        if (orderId) {
            const orderRef = firebase.database().ref("produtos/" + productId + "/pedidos/" + orderId + "/pix_info/");
            orderRef.once("value")
                .then(snapshot => {
                    if (snapshot.exists()) {
                        const order = snapshot.val();
                        console.log("Dados do pedido:", order);

                        $("#pix-container").show();
                        $("#checkout-form").hide();
                    } else {
                        console.error("❌ Pedido não encontrado.");
                    }
                })
                .catch(error => {
                    console.error("❌ Erro ao buscar pedido:", error);
                });
        }


        if (productId) {
            console.log("🔍 Buscando produto com ID:", productId);

            const productRef = firebase.database().ref("produtos/" + productId);
            const corp = document.getElementById("corp");
            const errorProd = document.getElementById("error-prod");

            productRef.once("value")
                .then(snapshot => {
                    if (snapshot.exists()) {
                        produto = snapshot.val();

                        $("#detalhes-prod").text(produto.nome);
                        $("#descricao-prod").text(produto.descricao);
                        $("#nome_vendedor").text(produto.nome_vendedor);
                        $("#preco-original").text(produto.preco_original);
                        let precoFormatado = `R$ ${produto.preco.toFixed(2).replace(".", ",")}`;
                        $("#preco-prod").text(`${precoFormatado}`);

                        document.title = produto.nome;

                        const imgElement = document.getElementById("img-head");
                        if (produto.banner_img) {
                            document.getElementById("banner").src = produto.banner_img;
                            document.getElementById("banner-div").style.display = "block";

                        } else {
                            document.getElementById("banner-div").style.display = "none";
                        }
                        if (produto.countdown === true) {
                            document.getElementById("timer").style.display = "flex";
                        } else {
                            document.getElementById("timer").style.display = "none";
                        }



                        // Verifica se a imagem existe antes de definir o src
                        if (produto.imagem) {
                            imgElement.src = produto.imagem;

                            // Adiciona um evento para remover a classe quando a imagem carregar
                            imgElement.onload = function () {
                                document.getElementById("head").classList.remove("bor");
                            };
                        } else {
                            alert("⚠️ Produto não possui uma imagem.");
                        }

                        console.log("✅ Produto encontrado");
                    } else {
                        console.error("❌ Produto não encontrado.");
                        document.getElementById("corp").classList.add('hide');
                        document.getElementById("error-prod").classList.remove('hide');
                    }
                })
                .catch(error => {
                    console.error("❌ Erro ao buscar produto:", error);
                    document.getElementById("corp").classList.add('hide');
                    document.getElementById("error-prod").classList.remove('hide');
                });

        } else {
            console.error("❌ Nenhum ID de produto foi fornecido na URL.");
            document.getElementById("corp").classList.add('hide');
            document.getElementById("error-prod").classList.remove('hide');

        }





        $("#checkout-form").submit(function (event) {
            document.getElementById("bob").classList.add("popup");
            event.preventDefault();
            $.post("https://versel-5pxj.onrender.com/create_pix", { // Alterado para Render
                nome_completo: $("#nome_completo").val(),
                email: $("#email").val(),
                preco: produto.preco.toFixed(2)
            }, function (data) {
                $("#pix-qr").attr("src", 'https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=' + data.pix_code);
                $("#pix-code").text(data.pix_code);
                $("#pix-container").show();
                $("#checkout-form").hide();
                document.getElementById("bob").classList.remove("popup");

                // Salva o ID do pagamento para verificação automática
                paymentId = data.payment_id;
                checkPaymentStatus();

                const pedidosRef = firebase.database().ref(`produtos/${productId}/pedidos`);
                // 🔥 Criar ordem de pagamento no Firebase com status "pending"

                // Atualiza a data e hora do pedido
                let agora = new Date();
                let dataAtu = agora.toLocaleDateString("pt-BR"); // Formato: DD/MM/AAAA
                let horaAtu = agora.toLocaleTimeString("pt-BR"); // Formato: HH:MM:SS

                // Cria um novo pedido no Firebase
                pedidosRef.child(paymentId).set({
                    nome: $("#nome_completo").val(),
                    email: $("#email").val(),
                    tel: tell.value.replace(/[+\- ]/g, ''),
                    preco: produto.preco.toFixed(2),
                    data: { // Aqui, transformamos "data" em um objeto
                        data: dataAtu,
                        hora: horaAtu,
                        data_payment: '',
                        hora_payment: ''
                    },
                    pix_info: {
                        pix_pago: 'pending',
                        pix_id: paymentId,
                        pix_code: data.pix_code,
                        pix_qr: 'https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=' + data.pix_code,
                        url_pix: window.location.href + '&order=' + paymentId,
                    },
                    status: "pending"
                }).then(() => {
                    console.log("Pedido criado com sucesso!");
                }).catch((error) => {
                    console.error("Erro ao criar o pedido:", error);
                });
            }).fail(() => {
                alert("Erro ao criar pagamento. Tente novamente.");
            });
        });

        // Verifica o status do pagamento a cada 6 segundos
        function checkPaymentStatus() {
            if (!paymentId) return;

            const interval = setInterval(() => {
                $.get(`https://versel-5pxj.onrender.com/check_payment/${paymentId}`, function (data) { // Alterado para Render
                    if (data.status === "approved") {
                        clearInterval(interval);
                        $("#pix-qr").attr("src", 'https://firebasestorage.googleapis.com/v0/b/loginxepa.appspot.com/o/img%2Fpago-transp3-150x150.png?alt=media&token=1bbb9be8-3a00-4678-b975-7a1a29ec64d5');
                        $("#pix-code-div").hide();
                        $("#status").text("Pagamento aprovado! Aguarde 1 segundo.");
                        $("#scan").text("Você receberá um email.");
                        $("#loading").hide();
                        $("#btnconf").hide();
                        $("#como-pagar").hide();

                        // Atualiza o status do pedido no Firebase
                        let agora = new Date();
                        let dataAtu = agora.toLocaleDateString("pt-BR"); // Formato: DD/MM/AAAA
                        let horaAtu = agora.toLocaleTimeString("pt-BR"); // Formato: HH:MM:SS

                        database.ref(`produtos/${productId}/pedidos/${paymentId}`).update({
                            status: "approved",
                            "data/data_payment": dataAtu,
                            "data/hora_payment": horaAtu,
                            "pix_info/pix_pago": "approved"
                        });

                        // Envia um e-mail com os dados do cliente

                        $.post("https://versel-5pxj.onrender.com/send-email", {
                            nome_completo: $("#nome_completo").val(),
                            email: $("#email").val(),
                            url_button: produto.url_button,
                            nome_produto: produto.nome,
                            nome_vendedor: produto.nome_vendedor,
                            email_vendedor: produto.email_vendedor,
                            preco: produto.preco.toFixed(2),
                        }).done(function () {
                            console.log("✅ E-mail enviado com sucesso!");
                        }).fail(function (xhr, status, error) {
                            console.error("❌ Erro ao enviar e-mail:", error);
                        });


                        setTimeout(() => {
                            window.location.href = produto.url_button;
                        }, 8000);
                    } else if (data.status === "rejected") {
                        clearInterval(interval);
                        alert("Pagamento rejeitado. Tente novamente.");
                        location.reload();
                    }
                }).fail(() => {
                    clearInterval(interval);
                    alert("Erro ao verificar pagamento.");
                });
            }, 6000); // Verifica a cada 6 segundos
        }

        document.getElementById('pix-code').addEventListener('click', function () {
            // Código mantido como no original
        });

        document.getElementById('btnconf').addEventListener('click', function () {
            navigator.clipboard.writeText(document.getElementById('pix-code').innerText)
                .then(() => {
                    document.getElementById("copy").classList.add("popup");
                    setTimeout(() => {
                        document.getElementById("copy").classList.remove("popup");
                    }, 2000);
                })
                .catch((error) => {
                    alert('Falha ao copiar texto para a área de transferência:', error);
                });
        });
        // Função para atualizar o cronômetro
        function startCountdown(duration) {
            let countdownElement = document.getElementById('countdown');
            let timer = duration, minutes, seconds;

            let interval = setInterval(function () {
                minutes = parseInt(timer / 60, 10);
                seconds = parseInt(timer % 60, 10);

                // Adiciona um zero à esquerda para os números menores que 10
                minutes = minutes < 10 ? '0' + minutes : minutes;
                seconds = seconds < 10 ? '0' + seconds : seconds;

                countdownElement.textContent = minutes + ":" + seconds;

                if (--timer < 0) {
                    clearInterval(interval);
                    countdownElement.textContent = "00:00";
                    alert("O tempo para o pagamento expirou.");
                    // Ação quando o tempo expirar (exemplo: redirecionar ou exibir uma mensagem)
                }
            }, 1000);
        }

        // Define o tempo de contagem regressiva (exemplo: 30 minutos)
        let countdownDuration = 10 * 60; // 30 minutos em segundos
        startCountdown(countdownDuration);



        // Formatação do campo de telefone
        document.getElementById('tel').addEventListener('input', function (e) {
            let value = e.target.value;

            // Se o usuário tentar apagar o +55, restauramos el

            // Remove tudo que não for número, exceto o "+55 "
            value = value.replace(/\D/g, '').replace(/^55/, '+55 ');

            // Formata como +55 XX XXXXX-XXXX
            if (value.length > 6) {
                value = value.replace(/^(\+55\s\d{2})(\d)/, '$1 $2'); // Espaço depois do DDD
            }
            if (value.length > 11) {
                value = value.replace(/(\d{5})(\d{4})$/, '$1-$2'); // Hífen antes dos últimos 4 dígitos
            }

            e.target.value = value; // Atualiza o campo
        });
        var tell = document.getElementById('tel');

    </script>

</body>

</html>